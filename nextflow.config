// below process declarations are biomix specific
process {
  withLabel: 'gpu' {
      executor = 'slurm'
      queue = 'gpu2'
      clusterOptions = '--gres=gpu:1 --partition=gpu2 --account=gpu2 --qos=gpu'
  }
}

conda {
  enabled = true
  cacheDir = ".nextflow/conda"   
  useMamba = false
}

singularity {
  enabled = true
  autoMounts = true
  // default singularity run options (enable GPU forwarding and bind project dir)
  runOptions = "--nv -B ${baseDir}"
}


process{
  withLabel: 'standard' {
    executor = 'slurm'
    queue = 'batch'
    cpus = 20
    memory = '80 GB'
    clusterOptions = '--partition=batch'
    time = '7d'
  }
}

params {
  // For 1st pipeline run:
  // Fill datasets with all relevant fasta files, format is: datasets = [EX1: "ex1.fasta", EX2: "ex2.fasta", EX3: "ex3.fasta"]
  // Location for output directory
  outdir = "${baseDir}/fixing_new_phidra"

  datasets = [
    // BATS: "/mnt/VEIL/users/nolanv/pipeline_project/VasilVEILPipeline/BATS_pfam_validated_full_protein_400min.fa",
    ENA: "${baseDir}/Short_ENA_test.pep",
    // GOV: "/mnt/VEIL/users/nolanv/pipeline_project/VasilVEILPipeline/GOV_pfam_validated_full_protein_400min.fa",
    // HOTS: "/mnt/VEIL/users/nolanv/pipeline_project/VasilVEILPipeline/HOTS_pfam_validated_full_protein_400min.fa"
  ]

  // Phidra directory path (use baseDir so path is correct inside container)
  phidra_dir = "${baseDir}/phidra"

  // Pfam database path (currently using pfam db from phidra)
  pfamDB = "${baseDir}/phidra/pfam_database"

  // Protein data. Format is: proteins = [ [protein : "RNR", pfamDomain: "path/to/tsv.tsv", subjectDB: "path/to/subjectDB.faa", pasv_align_refs: "path/to/pasv_align_refs.fa"], [protein : "PolB" ...], ... ]
  // if there is no pasv_align_refs for specified protein, can leave item out of list.
  
  pasv_proteins = ["RNR", "PolA"]  // list of proteins to run pasv on, must be in the proteins list
  tophit_proteins = ["helicase"] // list of proteins to annotate through tophit, must be in the proteins list
  domain_proteins = ["PolB"]

  pasv_threshold = 0.01

  pasv_settings = [
    PolA: [
      mapped_name: 'PolA_putative',
      roi_start: 521,
      roi_end: 923,
      cat_sites: "668,705,758,762",
      expected_sigs: ['RDKY','RDKF','RDKL']
    ],
    RNR: [
      mapped_name: 'RNR_putative',
      roi_start: 437,
      roi_end: 625,
      cat_sites: "437,439,441,462,438",
      expected_sigs: ['NCECL','NCECV']
    ]
  ]


  pfam_annotation_map = [
    "rPolB" : "PF00136",
    "pPolB" : "PF03175"
  ]

  proteins = [
    [ protein: "RNR", 
      pfamDomain: "/mnt/VEIL/users/nolanv/pipeline_project/VasilVEILPipeline/rnr_classIalpha_classII_PF00317_PF02867_PF08343_PF21995_ida_file.tsv", 
      subjectDB: "/mnt/VEIL/references/pasv/mmseqs_search/NrdAEJ_alldb_08_27_2018.clean_headers.faa",
      pasv_align_refs: "/mnt/VEIL/references/pasv/pasv_profile/rnr__classIa_classII__best_practices.fa"
      ], 
      
    [ protein: "PolA", 
      pfamDomain: "/mnt/VEIL/users/nolanv/pipeline_project/VasilVEILPipeline/pola_PF00476_ida_file.tsv", 
      subjectDB: "/mnt/VEIL/users/nolanv/pipeline_project/VasilVEILPipeline/uniprotkb_DNA_polymerase_A_plus_BATS_his.fasta",
      pasv_align_refs: "/mnt/VEIL/references/pasv/pasv_profile/pola_16_k12_ref.fa",
      ],

    // [ protein: "Helicase",
    //   pfamDomain: "/mnt/VEIL/tools/phidra_resources/ida_files/helicase_ida_file.tsv", 
    //   subjectDB: "/mnt/VEIL/references/helicase/HeliBase_v3_github.fasta",
    //   ],
    
    // [ protein: "PolB",
    //   pfamDomain: "/mnt/VEIL/tools/phidra_resources/ida_files/polb_PF08490_PR00136_PF03175_ida_file.tsv", 
    //   subjectDB: "/mnt/VEIL/tools/phidra_resources/subject_db/polb_refs_pPolB_rPolB_piPolB.fasta"
    //   ]
  ] 

  // After running the 1st pipeline run, do not change above fields.

  // For 2nd pipeline run:
  md = [0.3, 0.5]
  nn = [75, 100]
  mc = [10, 30]



  // With new pipeline format, specify selected genofeatures and excluded datasets here AFTER AND ONLY AFTER running for the first time.
  // Excluded genofeatures
  selected_genofeatures = ['RDKY','RDKF','RDKL','pPolB','rPolB', 'Dda', 'DnaB', 'Gp4', 'Gp41', 'RecA', 'RecB', 'SNF2', 'Twinkle', 'UvsW', 'UvsX', 'NCECA', 'NCEAL', 'NCECP', 'NCECL']

  genofeature_metadata = "/mnt/VEIL/users/nolanv/embedding_test/protein_metadata_all.txt"
  // Excluded datasets

  // Essentially activates the third run mode.
  genofeature_split_plots = true





  // All datasets to exclude from final analysis
  embedding_datasets = []
  
  embeddings = "/mnt/VEIL/users/nolanv/pipeline_project/VasilVEILPipeline/output_test/embeddings"
  final_md = 0.5
  final_nn = 100
  
  // regenerate corodinates
  selected_genofeatures_2 = ['RDKY','RDKF','RDKL','pPolB','rPolB', 'Dda', 'DnaB']
  clusters_dir = "/mnt/VEIL/users/nolanv/pipeline_project/VasilVEILPipeline/third_test/hdbscan/clusters_csv/plots"
  // add selected_genofeatures and datasets for final analysis like others.
}